# SQL ファイルから Flask-Migrate への移行ガイド

このガイドでは、既存の SQL ファイルベースのデータベース管理から、Flask-Migrate（Alembic）を使用した方法への移行手順を説明します。

## 現状のファイル構成

### 既存の SQL ファイル

```
db/
├── init.sql                              # 初期スキーマ
├── migration_add_notes.sql               # notesカラム追加
├── migration_add_templates.sql           # テンプレートテーブル追加
├── migration_add_capability_enabled.sql  # is_enabledカラム追加
├── migration_rename_template_tables.sql  # テーブル名変更
└── service_templates/                    # サービステンプレートSQL
    ├── slack.sql
    ├── github.sql
    ├── aws_s3.sql
    ├── openweather.sql
    ├── openai.sql
    └── google_calendar.sql
```

## 移行手順

### ステップ 1: 依存関係のインストール

```bash
pip install -r requirements.txt
```

### ステップ 2: 初期マイグレーションのセットアップ

```bash
python setup_migrations.py
```

これにより以下が実行されます：

- `migrations/`ディレクトリの作成
- モデルから初期マイグレーションファイルの生成

### ステップ 3: マイグレーションファイルの編集

生成された`migrations/versions/xxxx_initial_schema_with_all_tables.py`を編集して、テンプレートデータをロードする処理を追加します：

```python
"""Initial schema with all tables

Revision ID: xxxxxxxxxxxx
Revises:
Create Date: 2025-11-17 xx:xx:xx.xxxxxx

"""
from alembic import op
import sqlalchemy as sa
from app.utils.template_loader import load_service_templates


# revision identifiers, used by Alembic.
revision = 'xxxxxxxxxxxx'
down_revision = None
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Alembicが自動生成したテーブル作成コード
    # ...
    # ### end Alembic commands ###

    # テンプレートデータをロード
    load_service_templates()


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    # Alembicが自動生成したテーブル削除コード
    # ...
    # ### end Alembic commands ###
```

### ステップ 4: 既存データベースがある場合

#### オプション A: クリーンインストール（推奨）

```bash
# データベースを削除して再作成
docker-compose down -v
docker-compose up -d
```

#### オプション B: 既存 DB にマイグレーション履歴を追加

既存のデータベースを保持したい場合：

```bash
# 現在のスキーマ状態を「初期状態」として記録
python migrate.py stamp head
```

### ステップ 5: 動作確認

```bash
# マイグレーション状態を確認
python migrate.py current

# マイグレーション履歴を表示
python migrate.py history
```

## マイグレーションの対応表

既存の SQL ファイルは以下のように変換されます：

| 既存 SQL ファイル                      | マイグレーション対応                 |
| -------------------------------------- | ------------------------------------ |
| `init.sql`                             | モデル定義から自動生成               |
| `migration_add_notes.sql`              | 既にモデルに含まれている             |
| `migration_add_templates.sql`          | 既にモデルに含まれている             |
| `migration_add_capability_enabled.sql` | 既にモデルに含まれている             |
| `migration_rename_template_tables.sql` | 既にモデルに反映済み                 |
| `service_templates/*.sql`              | `load_service_templates()`で読み込み |

## 新しいマイグレーションの作成方法

### モデル変更の場合

1. `app/models/models.py`を編集
2. マイグレーションを生成：
   ```bash
   python migrate.py migrate "Description of change"
   ```
3. マイグレーションファイルを確認・編集
4. 適用：
   ```bash
   python migrate.py upgrade
   ```

### 新しいテンプレートの追加

1. `db/service_templates/new_service.sql`を作成
2. マイグレーションを生成：
   ```bash
   python migrate.py migrate "Add new service template"
   ```
3. 生成されたファイルを編集：
   ```python
   def upgrade():
       from app.utils.template_loader import load_service_templates
       load_service_templates()
   ```
4. 適用：
   ```bash
   python migrate.py upgrade
   ```

## Docker 環境での使用

### compose.yaml の設定

```yaml
services:
  web:
    # ...
    command: >
      sh -c "
        python migrate.py upgrade &&
        python run.py
      "
```

コンテナ起動時に自動的にマイグレーションが適用されます。

### 開発フロー

```bash
# ローカルでモデル変更
vim app/models/models.py

# マイグレーション生成
python migrate.py migrate "Add new field"

# Gitにコミット
git add migrations/versions/
git commit -m "Add migration: Add new field"

# Dockerで反映
docker-compose restart web
```

## トラブルシューティング

### マイグレーションが適用されない

```bash
# 現在の状態を確認
docker-compose exec web python migrate.py current

# 手動で適用
docker-compose exec web python migrate.py upgrade
```

### マイグレーション履歴をリセット

```bash
# データベースを完全にリセット
docker-compose down -v
docker-compose up -d
```

### 既存 SQL ファイルとの併用

移行期間中、既存の SQL ファイルは削除せずに保持できます。
`db/service_templates/`配下のファイルは、`load_service_templates()`を通じて引き続き使用されます。

## まとめ

- **既存の SQL ファイル**: `db/service_templates/`のみ継続使用
- **スキーマ管理**: Flask-Migrate で自動管理
- **データ投入**: `load_service_templates()`関数を通じて実行
- **履歴管理**: Alembic がバージョン管理

これにより、スキーマ変更の履歴管理、ロールバック、チーム開発での同期が容易になります。
